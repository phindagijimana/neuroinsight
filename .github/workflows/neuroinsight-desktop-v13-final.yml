name: Build Desktop v13 FINAL (Frontend Loading Fix)

on:
  push:
    tags:
      - 'desktop-v*'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
          ls -lh dist/
      
      - name: Install Node dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing npm dependencies..."
          npm install
      
      - name: Build Electron AppImage
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron AppImage..."
          echo "Note: Frontend is a single HTML file, no build needed"
          npm run build:linux
          echo "Build complete!"
          ls -lh dist/
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          sha256sum NeuroInsight-*.AppImage > checksums-linux.txt
          cat checksums-linux.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-linux
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-*.AppImage
            desktop_alone/electron-app/dist/checksums-linux.txt
          retention-days: 30
  
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
        shell: bash
      
      - name: Install Node dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing npm dependencies..."
          npm install
      
      - name: Build Electron installer
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron installer..."
          echo "Note: Frontend is a single HTML file, no build needed"
          npm run build:win
          echo "Build complete!"
        shell: bash
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          echo "Files in dist directory:"
          ls -la
          echo "Generating SHA256 for .exe files..."
          sha256sum NeuroInsight*.exe > checksums-windows.txt || sha256sum *Setup*.exe > checksums-windows.txt || echo "ERROR: No .exe files found!"
          echo "Checksum file:"
          cat checksums-windows.txt
        shell: bash
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-windows
          path: |
            desktop_alone/electron-app/dist/*.exe
            desktop_alone/electron-app/dist/checksums-windows.txt
          retention-days: 30
  
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
          ls -lh dist/
      
      - name: Install Node dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing npm dependencies..."
          npm install
      
      - name: Build Electron DMG
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron DMG..."
          echo "Note: Frontend is a single HTML file, no build needed"
          npm run build:mac
          echo "Build complete!"
          ls -lh dist/
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          shasum -a 256 NeuroInsight-*.dmg > checksums-mac.txt
          cat checksums-mac.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-mac
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-*.dmg
            desktop_alone/electron-app/dist/checksums-mac.txt
          retention-days: 30
  
  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/neuroinsight-linux/*
            artifacts/neuroinsight-windows/*
            artifacts/neuroinsight-mac/*
          body: |
            # NeuroInsight Desktop ${{ github.ref_name }}
            
            Automated hippocampal asymmetry analysis from T1-weighted MRI scans.
            
            ## ðŸ“¥ Downloads
            
            - **Linux**: `NeuroInsight-*.AppImage` (~3.9 GB) - No installation needed
            - **Windows**: `NeuroInsight-Setup-*.exe` (~4.0 GB) - Run installer
            - **macOS**: `NeuroInsight-*.dmg` (~4.0 GB) - Drag to Applications
            
            ## ðŸ”’ Security Verification
            
            Verify your download with the included `checksums-*.txt` files.
            
            **Note**: Apps are unsigned. See [INSTALLATION.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/INSTALLATION.md) for bypass instructions.
            
            ## ðŸš€ Quick Start
            
            **Linux**:
            ```bash
            chmod +x NeuroInsight-*.AppImage
            ./NeuroInsight-*.AppImage
            ```
            
            **Windows**: Run the installer  
            **macOS**: Right-click â†’ Open (first time only)
            
            ## âœ¨ Features
            
            - âœ… Automated brain segmentation with FastSurfer
            - âœ… Hippocampal volume calculation & asymmetry index
            - âœ… Multi-orientation viewer (axial, coronal, sagittal)
            - âœ… Opacity control (0-100%) & zoom controls
            - âœ… Real-time progress tracking (11 stages)
            - âœ… Crash logging for debugging
            - âœ… GPU/CPU automatic fallback
            
            ## ðŸ“š Documentation
            
            - [INSTALLATION.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/INSTALLATION.md) - Installation instructions
            - [USER_MANUAL.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/USER_MANUAL.md) - Complete user guide
            - [LOGS_AND_TROUBLESHOOTING.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/LOGS_AND_TROUBLESHOOTING.md) - Troubleshooting help
            
            ## ðŸ’» System Requirements
            
            - **RAM**: 8 GB minimum, 16 GB recommended
            - **Disk**: 10 GB free space
            - **GPU**: Optional (NVIDIA CUDA for faster processing)
            
            ## ðŸ“ž Support
            
            - Issues: https://github.com/phindagijimana/neuroinsight/issues
            - Email: neuroinsight@example.com
            
            ---
            
            **Version**: 1.1.0  
            **Date**: November 2025
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

