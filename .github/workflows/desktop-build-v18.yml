# Desktop Build v18 - Windows & Linux (Mock Data Fixes)
#
# ðŸš€ BUILDS FOR: Windows + Linux (macOS optional)
# âœ… FIXED: Mock FastSurfer data generation works properly
# âœ… ENHANCED: Improved smoke tests with metrics validation
# âœ… RELIABLE: Cross-platform builds with checksum verification
#
# ðŸ“¦ OUTPUTS:
# - Linux: NeuroInsight-*.AppImage (~3.6GB) + checksums
# - Windows: NeuroInsight-Setup-*.exe (~1GB) + checksums
# - Documentation: Installation guides and troubleshooting

name: Desktop Build v18 - Windows & Linux (Mock Data Fixes)

on:
  push:
    tags:
      - 'desktop-v*'
  workflow_dispatch:
    inputs:
      skip_macos:
        description: 'Skip macOS build (Windows + Linux only)'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller requests

      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
          ls -lh dist/neuroinsight-backend/

      - name: Verify frontend exists
        run: |
          echo "Checking for frontend/index.html..."
          ls -lh desktop_alone/frontend/index.html
          echo "Frontend file confirmed!"

      - name: Install Electron dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing Electron dependencies..."
          npm install

      - name: Build Electron AppImage
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron AppImage with fixed mock data..."
          npm run build:linux
          echo "Build complete!"
          ls -lh dist/

      - name: Verify frontend is bundled
        working-directory: desktop_alone/electron-app/dist/linux-unpacked/resources
        run: |
          echo "Verifying frontend is bundled in app.asar..."
          npx asar list app.asar | grep "frontend/index.html" && echo "âœ… Frontend is bundled!" || echo "âŒ Frontend missing!"

      - name: Verify Docker availability (Linux)
        run: |
          docker --version
          docker run --rm hello-world

      - name: Run backend smoke test (Linux)
        run: |
          echo "Running smoke test with mock FastSurfer data..."
          python tests/smoke_test.py \
            --backend-exe desktop_alone/dist/neuroinsight-backend/neuroinsight-backend \
            --input-nii desktop_alone/sample_image/sub-1_T1w_small.nii.gz \
            --fastsurfer-mode smoke \
            --max-processing-time 300 \
            --workspace smoke-linux \
            --api-port 8765 \
            --timeout 600

      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          find . -name "NeuroInsight-*.AppImage" -exec sha256sum {} \; > checksums-linux.txt
          echo "Linux checksums:"
          cat checksums-linux.txt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-linux
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-*.AppImage
            desktop_alone/electron-app/dist/checksums-linux.txt
          retention-days: 30

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller requests

      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          echo "PyInstaller version:"
          pyinstaller --version
          echo ""
          echo "Python version:"
          python --version
          echo ""
          echo "Starting build..."
          pyinstaller build.spec --clean --noconfirm --log-level=INFO 2>&1 | tee pyinstaller.log
          echo ""
          echo "PyInstaller build complete!"
          echo ""
          echo "Checking for errors..."
          if grep -i "error" pyinstaller.log; then
            echo "âš ï¸ Errors found in PyInstaller output"
          fi
          echo ""
          echo "Verifying backend was built..."
          if [ -d "dist/neuroinsight-backend" ]; then
            echo "âœ… Backend directory exists"
            ls -lh dist/neuroinsight-backend/ | head -10
          else
            echo "âŒ ERROR: Backend directory not found!"
            exit 1
          fi
        shell: bash

      - name: Verify frontend exists
        run: |
          echo "Checking for frontend/index.html..."
          ls -lh desktop_alone/frontend/index.html
          echo "Frontend file confirmed!"
        shell: bash

      - name: Install Electron dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing Electron dependencies..."
          npm install

      - name: Build Electron installer
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron installer with fixed mock data..."
          echo ""
          echo "Checking prerequisites..."
          if [ ! -d "../dist/neuroinsight-backend" ]; then
            echo "âŒ ERROR: Backend not found at ../dist/neuroinsight-backend"
            exit 1
          fi
          if [ ! -d "../frontend" ]; then
            echo "âŒ ERROR: Frontend not found at ../frontend"
            exit 1
          fi
          echo "âœ… Prerequisites verified"
          echo ""
          echo "Running electron-builder..."
          npm run build:win
          echo ""
          echo "Build complete! Checking output..."
          ls -lh dist/
        shell: bash

      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          echo "Looking for Windows installer..."
          if ls "NeuroInsight Setup"*.exe 1> /dev/null 2>&1; then
            echo "âœ… Found Windows installer"
            echo "Generating SHA256 checksums..."
            sha256sum "NeuroInsight Setup"*.exe > checksums-windows.txt
            echo "Checksums generated:"
            cat checksums-windows.txt
          else
            echo "âŒ ERROR: No Windows installer (.exe) found!"
            echo "Available files in dist/:"
            ls -la
            exit 1
          fi
        shell: bash

      - name: Run backend smoke test (Windows)
        run: |
          echo "Running smoke test with mock FastSurfer data..."
          python tests/smoke_test.py `
            --backend-exe desktop_alone/dist/neuroinsight-backend/neuroinsight-backend.exe `
            --input-nii desktop_alone/sample_image/sub-1_T1w_small.nii.gz `
            --fastsurfer-mode smoke `
            --max-processing-time 300 `
            --workspace smoke-windows `
            --api-port 8766 `
            --timeout 600
        shell: powershell

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-windows
          path: |
            desktop_alone/electron-app/dist/NeuroInsight Setup *.exe
            desktop_alone/electron-app/dist/NeuroInsight*Setup*.exe
            desktop_alone/electron-app/dist/checksums-windows.txt
          retention-days: 30

  build-macos:
    name: Build macOS DMG (Optional)
    runs-on: macos-latest
    if: ${{ github.event.inputs.skip_macos == 'false' || startsWith(github.ref, 'refs/tags/desktop-v') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller requests

      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
          ls -lh dist/neuroinsight-backend/

      - name: Verify frontend exists
        run: |
          echo "Checking for frontend/index.html..."
          ls -lh desktop_alone/frontend/index.html
          echo "Frontend file confirmed!"

      - name: Install Electron dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing Electron dependencies..."
          npm install

      - name: Build Electron DMG
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron DMG with fixed mock data..."
          npm run build:mac
          echo "Build complete!"
          ls -lh dist/
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          find . -name "NeuroInsight-*.dmg" -exec shasum -a 256 {} \; > checksums-mac.txt
          echo "macOS checksums:"
          cat checksums-mac.txt

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-mac
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-*.dmg
            desktop_alone/electron-app/dist/checksums-mac.txt
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR artifacts/

      - name: Check file sizes
        run: |
          echo "Checking file sizes (GitHub limit: 2GB per file)..."
          find artifacts -type f -exec ls -lh {} \; | grep -E "\.(AppImage|exe|dmg)$" || true
          echo ""
          echo "Files over 2GB will be skipped in release (available in Actions artifacts)"

      - name: Create Release (checksums only - installers too large)
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/neuroinsight-linux/checksums-linux.txt
            artifacts/neuroinsight-windows/checksums-windows.txt
          body: |
            # NeuroInsight Desktop ${{ github.ref_name }}

            Automated hippocampal asymmetry analysis from T1-weighted MRI scans.

            ## ðŸ†• What's New in v18

            âœ… **FIXED: Mock FastSurfer data generation** - Processing now works properly with mock data
            âœ… **IMPROVED: Smoke test reliability** - Better validation of metrics and visualizations
            âœ… **ENHANCED: Cross-platform builds** - Optimized Windows and Linux builds
            âœ… **STREAMLINED: Focus on Windows/Linux** - macOS build optional via workflow dispatch

            ## ðŸ“¥ Downloads

            **âš ï¸ Installers are too large for GitHub Releases (3.6GB > 2GB limit)**

            ### Download from GitHub Actions Artifacts:

            1. Go to the [Actions tab](https://github.com/phindagijimana/neuroinsight/actions/runs/${{ github.run_id }})
            2. Scroll down to "Artifacts" section
            3. Download your platform:
               - **neuroinsight-linux** (3.6 GB) - Contains AppImage + checksums
               - **neuroinsight-windows** (1 GB) - Contains Setup.exe + checksums

            ### Checksums (Available in this release):
            - `checksums-linux.txt` âœ…
            - `checksums-windows.txt` âœ…

            ## ðŸ”’ Security Verification

            Verify your download with the included `checksums-*.txt` files.

            **Note**: Apps are unsigned. See [INSTALLATION.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/INSTALLATION.md) for bypass instructions.

            ## ðŸš€ Quick Start

            **After downloading from Actions Artifacts:**

            **Linux**:
            ```bash
            unzip neuroinsight-linux.zip
            chmod +x NeuroInsight-*.AppImage
            ./NeuroInsight-*.AppImage
            ```

            **Windows**:
            ```bash
            unzip neuroinsight-windows.zip
            # Run the NeuroInsight-Setup-*.exe installer
            ```

            ## âœ¨ Features

            - âœ… Automated brain segmentation with FastSurfer
            - âœ… Hippocampal volume calculation & asymmetry index
            - âœ… Multi-orientation viewer (axial, coronal, sagittal)
            - âœ… Opacity control (0-100%) & zoom controls
            - âœ… Real-time progress tracking (11 stages)
            - âœ… Crash logging for debugging
            - âœ… GPU/CPU automatic fallback
            - âœ… Mock data support for testing

            ## ðŸ“š Documentation

            - [INSTALLATION.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/INSTALLATION.md) - Installation instructions
            - [USER_MANUAL.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/USER_MANUAL.md) - Complete user guide
            - [DESKTOP_TESTING_COMMANDS.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/DESKTOP_TESTING_COMMANDS.md) - Testing commands

            ## ðŸ’» System Requirements

            - **RAM**: 8 GB minimum, 16 GB recommended
            - **Disk**: 10 GB free space
            - **GPU**: Optional (NVIDIA CUDA for faster processing)

            ## ðŸ“ž Support

            - Issues: https://github.com/phindagijimana/neuroinsight/issues
            - Email: support@neuroinsight.app

            ---

            **Version**: 1.3.23
            **Date**: November 2025
            **Build**: v18 (Mock Data Fixes)
