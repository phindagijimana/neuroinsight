name: Desktop Nightly Validation v4

on:
  schedule:
    - cron: "30 5 * * *"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  FASTSURFER_IMAGE: "deepmi/fastsurfer:latest"
  SAMPLE_T1_PATH: "desktop_alone/sample_image/sub-1_T1w.nii.gz"

jobs:
  linux:
    name: FastSurfer Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure sample image (Git LFS)
        run: |
          set -euo pipefail
          git lfs install --local
          git lfs pull -I "$SAMPLE_T1_PATH"
          if [ ! -f "$SAMPLE_T1_PATH" ]; then
            echo "Sample T1 image missing after git lfs pull" >&2
            exit 1
          fi

      - name: Free disk space (Linux)
        run: |
          set -e
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"/CodeQL || true
          sudo docker system prune -af || true
          df -h

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller requests

      - name: Build backend executable
        working-directory: desktop_alone
        run: |
          pyinstaller build.spec --clean --noconfirm

      - name: Prepare Docker (Linux)
        run: |
          docker --version
          docker pull $FASTSURFER_IMAGE

      - name: Run FastSurfer end-to-end (Linux)
        run: |
          set -euo pipefail
          python tests/smoke_test.py \
            --backend-exe desktop_alone/dist/neuroinsight-backend/neuroinsight-backend \
            --workspace nightly-linux \
            --api-port 8875 \
            --timeout 3600 \
            --fastsurfer-mode real \
            --input-nii "$SAMPLE_T1_PATH" \
          2>&1 | tee nightly-linux.log

      - name: Upload nightly log (Linux)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-linux-log
          path: nightly-linux.log

  windows:
    name: FastSurfer Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure sample image (Git LFS)
        shell: bash
        run: |
          set -euo pipefail
          git lfs install --local
          git lfs pull -I "$SAMPLE_T1_PATH"
          if [ ! -f "$SAMPLE_T1_PATH" ]; then
            echo "Sample T1 image missing after git lfs pull" >&2
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller requests

      - name: Build backend executable
        working-directory: desktop_alone
        run: |
          pyinstaller build.spec --clean --noconfirm

      - name: Run FastSurfer end-to-end (Windows)
        shell: powershell
        run: |
          Write-Host "Linux containers are not supported on hosted Windows runners; running smoke fallback."
          $command = "python tests\smoke_test.py --backend-exe desktop_alone\dist\neuroinsight-backend\neuroinsight-backend.exe --workspace nightly-windows --api-port 8876 --timeout 1800 --fastsurfer-mode smoke --input-nii desktop_alone\sample_image\sub-1_T1w.nii.gz"
          Invoke-Expression "$command 2>&1 | Tee-Object -FilePath nightly-windows.log"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload nightly log (Windows)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-windows-log
          path: nightly-windows.log

  macos:
    name: FastSurfer macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure sample image (Git LFS)
        run: |
          set -euo pipefail
          git lfs install --local
          git lfs pull -I "$SAMPLE_T1_PATH"
          if [ ! -f "$SAMPLE_T1_PATH" ]; then
            echo "Sample T1 image missing after git lfs pull" >&2
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller requests

      - name: Build backend executable
        working-directory: desktop_alone
        run: |
          pyinstaller build.spec --clean --noconfirm

      - name: Install and start Colima
        id: install_colima
        run: |
          brew install qemu docker colima lima lima-additional-guestagents
          colima start --cpu 4 --memory 8 --disk 30 --arch x86_64

      - name: Prepare Docker (macOS)
        run: |
          docker --version
          docker pull $FASTSURFER_IMAGE

      - name: Run FastSurfer end-to-end (macOS)
        run: |
          set -euo pipefail
          python tests/smoke_test.py \
            --backend-exe desktop_alone/dist/neuroinsight-backend/neuroinsight-backend \
            --workspace nightly-macos \
            --api-port 8877 \
            --timeout 3600 \
            --fastsurfer-mode real \
            --input-nii "$SAMPLE_T1_PATH" \
          2>&1 | tee nightly-macos.log

      - name: Stop Colima
        if: always() && steps.install_colima.outcome == 'success'
        run: |
          colima stop

      - name: Upload nightly log (macOS)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-macos-log
          path: nightly-macos.log


