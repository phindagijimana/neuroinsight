name: Build Desktop App (All Platforms)

on:
  push:
    tags:
      - 'desktop-v*'  # Trigger on tags like desktop-v1.0.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: NeuroInsight-*.AppImage
          - os: windows-latest
            platform: windows
            artifact: NeuroInsight-Setup-*.exe
          - os: macos-latest
            platform: mac
            artifact: NeuroInsight-*.dmg
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_alone/electron-app/package-lock.json
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
      
      - name: Install PyInstaller
        run: pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building Python backend..."
          pyinstaller build.spec --clean --noconfirm
      
      - name: Install Node dependencies
        working-directory: desktop_alone/electron-app
        run: npm ci
      
      - name: Build Electron app (Linux)
        if: matrix.platform == 'linux'
        working-directory: desktop_alone/electron-app
        run: npm run build:linux
      
      - name: Build Electron app (Windows)
        if: matrix.platform == 'windows'
        working-directory: desktop_alone/electron-app
        run: npm run build:win
      
      - name: Build Electron app (macOS)
        if: matrix.platform == 'mac'
        working-directory: desktop_alone/electron-app
        run: npm run build:mac
        env:
          # For macOS code signing (optional)
          # CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
          # NOTARIZE: false  # Set to true if you have Apple Developer account
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          if [ "$RUNNER_OS" == "Linux" ] || [ "$RUNNER_OS" == "macOS" ]; then
            sha256sum ${{ matrix.artifact }} > checksums-${{ matrix.platform }}.txt
          else
            certutil -hashfile $(ls ${{ matrix.artifact }}) SHA256 > checksums-${{ matrix.platform }}.txt
          fi
        shell: bash
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-${{ matrix.platform }}
          path: |
            desktop_alone/electron-app/dist/${{ matrix.artifact }}
            desktop_alone/electron-app/dist/checksums-${{ matrix.platform }}.txt
          retention-days: 30
  
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: ls -R artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/neuroinsight-linux/*
            artifacts/neuroinsight-windows/*
            artifacts/neuroinsight-mac/*
          body: |
            # NeuroInsight Desktop ${{ github.ref_name }}
            
            Automated hippocampal asymmetry analysis from T1-weighted MRI scans.
            
            ## Downloads
            
            - **Linux**: `NeuroInsight-*.AppImage` (No installation needed)
            - **Windows**: `NeuroInsight-Setup-*.exe` (Run installer)
            - **macOS**: `NeuroInsight-*.dmg` (Drag to Applications)
            
            ## Installation
            
            See [INSTALLATION.md](https://github.com/${{ github.repository }}/blob/main/desktop_alone/INSTALLATION.md) for detailed instructions.
            
            ## Features
            
            - ‚úÖ Automated brain segmentation with FastSurfer
            - ‚úÖ Hippocampal volume calculation
            - ‚úÖ Asymmetry index computation
            - ‚úÖ Multi-orientation viewer (axial, coronal, sagittal)
            - ‚úÖ Opacity control for overlays
            - ‚úÖ Zoom controls
            - ‚úÖ Real-time progress tracking (11 stages)
            - ‚úÖ Comprehensive crash logging
            - ‚úÖ GPU/CPU automatic fallback
            
            ## Checksums
            
            Verify your download with the included `checksums-*.txt` files.
            
            ## Support
            
            - üìñ User Manual: See USER_MANUAL.md in the repository
            - üêõ Issues: https://github.com/${{ github.repository }}/issues
            - üìß Email: [your-email]
            
            ---
            
            **Note**: Apps are unsigned. See installation guide for security warning bypass instructions.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
