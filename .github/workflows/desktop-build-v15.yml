name: Desktop Build v15 - Fixed (Frontend Bundled)

on:
  push:
    tags:
      - 'desktop-v*'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
          ls -lh dist/
      
      - name: Verify frontend exists
        run: |
          echo "Checking for frontend/index.html..."
          ls -lh desktop_alone/frontend/index.html
          echo "Frontend file confirmed!"
      
      - name: Install Electron dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing Electron dependencies..."
          npm install
      
      - name: Build Electron AppImage
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron AppImage with FIXED frontend bundling..."
          npm run build:linux
          echo "Build complete!"
          ls -lh dist/
      
      - name: Verify frontend is bundled
        working-directory: desktop_alone/electron-app/dist/linux-unpacked/resources
        run: |
          echo "Verifying frontend is bundled in app.asar..."
          npx asar list app.asar | grep "frontend/index.html" && echo "âœ… Frontend is bundled!" || echo "âŒ Frontend missing!"
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          sha256sum NeuroInsight-*.AppImage > checksums-linux.txt
          cat checksums-linux.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-linux
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-*.AppImage
            desktop_alone/electron-app/dist/checksums-linux.txt
          retention-days: 30
  
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
        shell: bash
      
      - name: Verify frontend exists
        run: |
          echo "Checking for frontend/index.html..."
          ls -lh desktop_alone/frontend/index.html
          echo "Frontend file confirmed!"
        shell: bash
      
      - name: Install Electron dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing Electron dependencies..."
          npm install
      
      - name: Build Electron installer
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron installer with FIXED frontend bundling..."
          npm run build:win
          echo "Build complete!"
        shell: bash
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          echo "Files in dist directory:"
          ls -la
          echo "Generating SHA256 for .exe files..."
          sha256sum NeuroInsight*.exe > checksums-windows.txt || sha256sum *Setup*.exe > checksums-windows.txt || echo "ERROR: No .exe files found!"
          echo "Checksum file:"
          cat checksums-windows.txt || echo "No checksum file created"
        shell: bash
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-windows
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-Setup-*.exe
            desktop_alone/electron-app/dist/checksums-windows.txt
          retention-days: 30
  
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r desktop_alone/requirements.txt
          pip install pyinstaller
      
      - name: Build Python backend
        working-directory: desktop_alone
        run: |
          echo "Building backend with PyInstaller..."
          pyinstaller build.spec --clean --noconfirm
          echo "Backend built successfully!"
          ls -lh dist/
      
      - name: Verify frontend exists
        run: |
          echo "Checking for frontend/index.html..."
          ls -lh desktop_alone/frontend/index.html
          echo "Frontend file confirmed!"
      
      - name: Install Electron dependencies
        working-directory: desktop_alone/electron-app
        run: |
          echo "Installing Electron dependencies..."
          npm install
      
      - name: Build Electron DMG
        working-directory: desktop_alone/electron-app
        run: |
          echo "Building Electron DMG with FIXED frontend bundling..."
          npm run build:mac
          echo "Build complete!"
          ls -lh dist/
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Verify frontend is bundled
        working-directory: desktop_alone/electron-app/dist/mac
        run: |
          echo "Verifying frontend is bundled in app..."
          if [ -d "NeuroInsight.app" ]; then
            find NeuroInsight.app -name "index.html" && echo "âœ… Frontend is bundled!" || echo "âŒ Frontend missing!"
          fi
      
      - name: Generate checksums
        working-directory: desktop_alone/electron-app/dist
        run: |
          echo "Generating checksums..."
          shasum -a 256 NeuroInsight-*.dmg > checksums-mac.txt
          cat checksums-mac.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neuroinsight-mac
          path: |
            desktop_alone/electron-app/dist/NeuroInsight-*.dmg
            desktop_alone/electron-app/dist/checksums-mac.txt
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR artifacts/
      
      - name: Check file sizes
        run: |
          echo "Checking file sizes (GitHub limit: 2GB per file)..."
          find artifacts -type f -exec ls -lh {} \; | grep -E "\.(AppImage|exe|dmg)$" || true
          echo ""
          echo "Files over 2GB will be skipped in release (available in Actions artifacts)"
      
      - name: Create Release (checksums only - installers too large)
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/neuroinsight-linux/checksums-linux.txt
            artifacts/neuroinsight-windows/checksums-windows.txt
            artifacts/neuroinsight-mac/checksums-mac.txt
          body: |
            # NeuroInsight Desktop ${{ github.ref_name }}
            
            Automated hippocampal asymmetry analysis from T1-weighted MRI scans.
            
            ## ðŸ› Bug Fixes in This Release
            
            âœ… **FIXED: Dark window issue** - Frontend now properly bundled in all installers
            
            ## ðŸ“¥ Downloads
            
            **âš ï¸ Installers are too large for GitHub Releases (2.8GB > 2GB limit)**
            
            ### Download from GitHub Actions Artifacts:
            
            1. Go to the [Actions tab](https://github.com/phindagijimana/neuroinsight/actions/runs/${{ github.run_id }})
            2. Scroll down to "Artifacts" section
            3. Download your platform:
               - **neuroinsight-linux** (2.8 GB) - Contains AppImage
               - **neuroinsight-windows** - Contains Setup.exe
               - **neuroinsight-mac** (460 MB) - Contains DMG files
            
            ### Checksums (Available in this release):
            - `checksums-linux.txt` âœ…
            - `checksums-windows.txt` âœ…
            - `checksums-mac.txt` âœ…
            
            ## ðŸ”’ Security Verification
            
            Verify your download with the included `checksums-*.txt` files.
            
            **Note**: Apps are unsigned. See [INSTALLATION.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/INSTALLATION.md) for bypass instructions.
            
            ## ðŸš€ Quick Start
            
            **After downloading from Actions Artifacts:**
            
            **Linux**:
            ```bash
            unzip neuroinsight-linux.zip
            chmod +x NeuroInsight-*.AppImage
            ./NeuroInsight-*.AppImage
            ```
            
            **Windows**:
            ```bash
            unzip neuroinsight-windows.zip
            # Run the NeuroInsight-Setup-*.exe installer
            ```
            
            **macOS**:
            ```bash
            unzip neuroinsight-mac.zip
            # Open the .dmg file and drag to Applications
            # Right-click â†’ Open (first time only)
            ```
            
            ## âœ¨ Features
            
            - âœ… Automated brain segmentation with FastSurfer
            - âœ… Hippocampal volume calculation & asymmetry index
            - âœ… Multi-orientation viewer (axial, coronal, sagittal)
            - âœ… Opacity control (0-100%) & zoom controls
            - âœ… Real-time progress tracking (11 stages)
            - âœ… Crash logging for debugging
            - âœ… GPU/CPU automatic fallback
            
            ## ðŸ“š Documentation
            
            - [INSTALLATION.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/INSTALLATION.md) - Installation instructions
            - [USER_MANUAL.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/USER_MANUAL.md) - Complete user guide
            - [LOGS_AND_TROUBLESHOOTING.md](https://github.com/phindagijimana/neuroinsight/blob/main/desktop_alone/LOGS_AND_TROUBLESHOOTING.md) - Troubleshooting help
            
            ## ðŸ’» System Requirements
            
            - **RAM**: 8 GB minimum, 16 GB recommended
            - **Disk**: 10 GB free space
            - **GPU**: Optional (NVIDIA CUDA for faster processing)
            
            ## ðŸ“ž Support
            
            - Issues: https://github.com/phindagijimana/neuroinsight/issues
            - Email: neuroinsight@example.com
            
            ---
            
            **Version**: 1.1.1  
            **Date**: November 2025  
            **Build**: v15 (Frontend Bundling Fixed)

