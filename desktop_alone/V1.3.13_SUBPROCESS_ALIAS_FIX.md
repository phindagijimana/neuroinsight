# Desktop v1.3.13 ‚Äì Subprocess Scope Fix

**Release Date:** November 12, 2025  
**Build Tag:** `desktop-v1.3.13`  
**Status:** Hotfix (supersedes v1.3.12 artifacts)

---

## üêû Bug Fixed

### Processing failed: `local variable 'subprocess' referenced before assignment`

- **Symptom:** Jobs progressed to 20% (`Running FastSurfer...`) and then failed immediately, falling back to mock data.
- **Cause:** PyInstaller picked up an older code path where `_run_fastsurfer()` still contained a local `import subprocess`, leading Python to treat `subprocess` as a local variable and throwing `UnboundLocalError`.
- **Fix:** Renamed the module import to `import subprocess as subprocess_module` and updated every reference to use the alias. This guarantees the module binding survives even if legacy builds still contain the inner import.

---

## üì¶ Files Changed

1. `desktop_alone/pipeline/processors/mri_processor.py`
   - Renamed the subprocess import to `subprocess_module`.
   - Updated all subprocess usages (run, Popen, TimeoutExpired, etc.) to use the alias.
   - Prevents Python from shadowing the module with any latent local imports.

2. `desktop_alone/electron-app/package.json`
   - Version bump: `1.3.12` ‚Üí `1.3.13`.

3. `desktop_alone/V1.3.13_SUBPROCESS_ALIAS_FIX.md`
   - This release note.

---

## ‚úÖ Impact

- Windows users now receive the fully updated backend binary, guaranteed to run real FastSurfer processing.
- macOS/Linux builds inherit the fix automatically; no behaviour change other than stability.
- Future builds with the same code cannot regress into the `UnboundLocalError`.

---

## üîÑ Upgrade Guidance

1. Uninstall previous NeuroInsight Desktop builds (1.3.11 or 1.3.12).  
2. Clear `%LOCALAPPDATA%\Programs\NeuroInsight` if it still exists.  
3. Install the GitHub Actions artifact named `NeuroInsight Setup 1.3.13.exe`.  
4. Verify the backend timestamp matches the latest build (PowerShell):
   ```powershell
   Get-Item "$env:LOCALAPPDATA\Programs\NeuroInsight\resources\backend\neuroinsight-backend.exe" |
       Select-Object LastWriteTime, Length
   ```
5. Launch the app, upload a scan, confirm the job progresses beyond 20% without errors.

---

## üß™ Testing

- ‚úÖ `sub-268_T1w.nii` processed successfully on Windows 11 (CPU-only, Docker Desktop running).
- ‚úÖ Verified FastSurfer Docker pulls and segmentation complete without fallback to mock data.
- ‚úÖ Metrics written to SQLite; overlays available without 404 responses.

---

Happy processing! üéâ




