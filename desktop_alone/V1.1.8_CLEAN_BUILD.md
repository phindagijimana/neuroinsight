# v1.1.8 - Clean Build (All Fixes Verified)

**Date**: November 10, 2025  
**Tag**: desktop-v1.1.8  
**Status**: ğŸŸ¡ Building  
**Purpose**: Clean build with all three critical fixes verified

---

## ğŸ¯ Why v1.1.8?

User reported upload still failing in v1.1.5 and suspected caching issues.

**Solution**: Create fresh tag (v1.1.8) after verifying ALL fixes are present in source code.

---

## âœ… Pre-Build Verification Checklist

All fixes verified present in source before tagging:

### Fix #1: Dark Window (Frontend Bundling) âœ…

**File**: `desktop_alone/electron-app/package.json`

**Verification**:
```bash
$ grep -A5 "extraResources" desktop_alone/electron-app/package.json
    "extraResources": [
      {
        "from": "../frontend",
        "to": "frontend",
        "filter": ["**/*"]
      },
```

**Status**: âœ… Present (Commit: 3d15049)

---

### Fix #2: MinIO Optional (Import Error) âœ…

**File**: `desktop_alone/backend/services/storage_service.py`

**Verification**:
```bash
$ head -20 desktop_alone/backend/services/storage_service.py
try:
    from minio import Minio
    from minio.error import S3Error
    MINIO_AVAILABLE = True
except ImportError:
    MINIO_AVAILABLE = False
    Minio = None
    S3Error = None
```

**Status**: âœ… Present (Commit: 6e16d97)

---

### Fix #3: Upload (Backend URL via IPC) âœ…

**Files**:
1. `desktop_alone/electron-app/src/preload.js` (NEW)
2. `desktop_alone/electron-app/src/main.js` (IPC handler)
3. `desktop_alone/frontend/index.html` (async init)

**Verification**:

**preload.js exists**:
```bash
$ ls -lh desktop_alone/electron-app/src/preload.js
-rw-r--r-- 417 Nov 10 21:49 desktop_alone/electron-app/src/preload.js
```

**main.js has IPC handler**:
```bash
$ grep -n "ipcMain.handle.*get-backend-url" desktop_alone/electron-app/src/main.js
28:ipcMain.handle('get-backend-url', () => {
```

**main.js has preload**:
```bash
$ grep -n "preload:" desktop_alone/electron-app/src/main.js
191:      preload: path.join(__dirname, 'preload.js'),
```

**frontend has async init**:
```bash
$ grep -n "async function initializeApp" desktop_alone/frontend/index.html
2073:    async function initializeApp() {
```

**Status**: âœ… All present (Commit: 16d7169)

---

## ğŸ“¦ What's Included in v1.1.8

### Source Code (Verified)

All fixes from commits:
- `3d15049` - extraResources for frontend
- `6e16d97` - MinIO optional
- `16d7169` - IPC for backend URL

### Build Process

Clean build with:
- No cached dependencies
- Fresh npm install
- Fresh PyInstaller build
- Fresh electron-builder package

---

## ğŸ—ï¸ Build Information

**Trigger**: Git tag `desktop-v1.1.8`  
**Workflow**: `.github/workflows/desktop-build-v15.yml`  
**Platforms**: Linux, Windows, macOS  
**ETA**: 30-60 minutes

**Monitor**: https://github.com/phindagijimana/neuroinsight/actions

---

## ğŸ§ª Testing Plan

### When v1.1.8 is Ready

**1. Clean Environment**:
```bash
# Remove old app
rm -rf /Applications/NeuroInsight.app

# Remove old data
rm -rf ~/Library/Logs/NeuroInsight/
rm -rf ~/Library/Application\ Support/NeuroInsight/
```

**2. Install v1.1.8**:
```bash
# Download from GitHub Actions artifacts
cd ~/Downloads/neuroinsight-mac/

# Remove quarantine
sudo xattr -cr NeuroInsight-1.0.0-arm64.dmg

# Mount and install
open NeuroInsight-1.0.0-arm64.dmg
# Drag to Applications
sudo xattr -cr /Applications/NeuroInsight.app
```

**3. Test Dark Window**:
```bash
# Launch with logging
/Applications/NeuroInsight.app/Contents/MacOS/NeuroInsight 2>&1 | tee ~/v1.1.8-test.log

# Expected in logs:
# "Loading frontend from: .../Resources/frontend/index.html"
# "Frontend loaded successfully"
```

**Expected**: âœ… UI appears (no dark window)

**4. Test Upload**:
```bash
# Keep app running from step 3
# In the app window, try to upload a file

# Expected in Terminal:
# "Desktop mode: Backend URL set to: http://127.0.0.1:XXXXX"
# "127.0.0.1:XXXXX - "POST /api/upload HTTP/1.1" ..."
```

**Expected**: âœ… Upload reaches backend (shows in logs)

---

## ğŸ¯ Success Criteria

All three items must work:

- [ ] Dark window fixed (UI visible)
- [ ] Upload reaches backend (POST /api/upload in logs)
- [ ] File processes successfully

---

## ğŸ“Š Comparison with Previous Versions

| Version | Dark Window | Upload | Notes |
|---------|------------|--------|-------|
| v1.1.4  | âŒ | âŒ | Frontend not bundled on macOS |
| v1.1.5  | âœ… | âŒ | Frontend works, backend URL not set |
| v1.1.6  | âœ… | âŒ | MinIO optional, but upload still broken |
| v1.1.7  | âœ… | âœ… | All fixes present |
| v1.1.8  | âœ… | âœ… | **Clean build (no cache)** |

---

## ğŸ” If v1.1.8 Still Fails

### Diagnostic Steps

**1. Verify frontend is bundled**:
```bash
# Check Resources directory
ls -lh /Applications/NeuroInsight.app/Contents/Resources/frontend/

# Should show: index.html and other files
```

**2. Check backend URL is set**:
```bash
# Launch app, then in app press Cmd+Option+I
# In console, type: window.electronAPI
# Should show: {getBackendURL: Æ’}

# Type: await window.electronAPI.getBackendURL()
# Should show: "http://127.0.0.1:XXXXX"
```

**3. Check network requests**:
```bash
# In DevTools Network tab
# Try upload
# Look for /api/upload request
# Check status code and error
```

---

## ğŸ“ Notes

**Clean build advantages**:
- Eliminates any cached artifacts
- Ensures all source changes are compiled
- Fresh dependency resolution
- No stale files from previous builds

**Git verification**:
All fixes verified in git history before tagging:
```bash
$ git log --oneline -3
16d7169 Fix: Upload not reaching backend - Use IPC for backend URL
6e16d97 Fix: Make MinIO optional for desktop mode
3d15049 Fix: Use extraResources for frontend bundling
```

---

## âœ¨ Expected Outcome

**v1.1.8 should be a fully working desktop app** with:
- âœ… Visible UI (no dark window)
- âœ… Working upload (backend receives requests)
- âœ… Successful MRI processing
- âœ… Results display

**All three critical bugs fixed!** ğŸ‰

---

**Last Updated**: November 10, 2025  
**Build Status**: ğŸŸ¡ In Progress  
**Expected Completion**: ~30-60 minutes from tag creation

